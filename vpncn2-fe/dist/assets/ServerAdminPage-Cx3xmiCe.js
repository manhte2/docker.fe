import{j as e,af as se,S as W,a as x,B as l,l as k,r,ag as pe,L as te,ak as fe,m as ye,al as ge,am as ae,f as je,a8 as w,g as ve,ai as Ne,an as we,q as be,ac as ke,i as Se,ao as Ce,d as y,D as P,T as Ae,ap as Te,b as Q,R as Ie,z as Be,C as ee,H as b,I as U,aj as Me,k as Le,F as B,aq as M,ae as Fe,ar as L,ah as _e,o as qe}from"./index-DCVJyVHf.js";import{E as $e,B as De,a as Ee,P as Ke,b as Re}from"./ServerDetailAdminPage-EAuWluN0.js";import{C as Pe}from"./Checkbox-CT2LGWNP.js";import"./Radio-DZfiCLHa.js";import"./EditKeyLimitForm-DBGrrKn0.js";const Ue=({className:n=""})=>e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:se("size-5",n),children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75"})}),We=[{id:1,title:"Active"},{id:2,title:"Down"},{id:3,title:"Maintenance"}],ze=({serverId:n,status:i,handleFetchData:u})=>{const d=async(a,g)=>{var h;try{const{isConfirmed:c}=await W.fire({title:'<p class="leading-tight">Bạn có muốn thay đổi trạng thái máy chủ này</p>',icon:"success",showCancelButton:!0,confirmButtonColor:"#1DC071",cancelButtonColor:"#d33",cancelButtonText:"Thoát",confirmButtonText:"Đồng ý"});c&&(await x.patch(`/servers/status-server/${a}`,{status:g}),u(),l.success("Thành công"))}catch(c){if(k.isAxiosError(c))console.log("error message: ",c),l.error((h=c.response)==null?void 0:h.data.message);else return console.log("unexpected error: ",c),"An unexpected error occurred"}};return e.jsxs("div",{className:"flex gap-2 relative group",children:[e.jsx("div",{className:"size-7 rounded-md bg-primary40 flex items-center justify-center text-white",children:e.jsx(Ue,{})}),e.jsx("div",{className:"absolute z-[10000000000] bg-primary40 rounded-md overflow-hidden shadow-xl bottom-full left-0 opacity-0 invisible group-hover:opacity-100 group-hover:visible",children:We.map(a=>a.id!==i?e.jsx("button",{type:"button",className:"px-5 py-1 font-medium text-white",onClick:()=>d(n,a.id),children:a.title},a.id):null)})]})},He=({serverId:n,handleFetchData:i,serverName:u})=>{const[d,a]=r.useState(!1),g=async h=>{var c;try{const{isConfirmed:m,isDenied:S}=await W.fire({title:`<p class="leading-tight">Xóa máy chủ ${u}</p>`,icon:"success",showCancelButton:!0,confirmButtonColor:"#1DC071",cancelButtonColor:"#d33",cancelButtonText:"Thoát",confirmButtonText:"Xóa cùng Kuma",denyButtonText:"Chỉ xóa",denyButtonColor:"#d33",showDenyButton:!0});m&&(a(!0),(await x.get(`/keys?serverId=${h}&status=1`)).data.length>0?l.warn("Bạn phải migrate key sang server khác trước khi muốn xóa"):(await x.delete(`/servers/${h}`,{params:{isDeleteKuma:1}}),i(),l.success("Xóa thành công"))),S&&(a(!0),(await x.get(`/keys?serverId=${h}&status=1`)).data.length>0?l.warn("Bạn phải migrate key sang server khác trước khi muốn xóa"):(await x.delete(`/servers/${h}`),i(),l.success("Xóa thành công")))}catch(m){if(k.isAxiosError(m))console.log("error message: ",m),l.error((c=m.response)==null?void 0:c.data.message);else return console.log("unexpected error: ",m),"An unexpected error occurred"}finally{a(!1)}};return e.jsx("button",{className:"w-7 flex items-center justify-center aspect-square text-xs font-medium text-white rounded-md bg-error font-primary",onClick:()=>g(n),children:d?e.jsx("div",{className:"w-3 h-3 border-white border-2 border-solid border-t-transparent animate-spin rounded-full"}):e.jsx(pe,{className:"size-4"})})},Ve=({serverName:n,serverId:i,onSuccess:u=()=>{}})=>{const[d,a]=r.useState(!1);return d?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($e,{containerClass:"w-[120px]",isButtonSubmit:!1,placeholder:n,handleEdit:async g=>{try{await x.patch(`/servers/name-server/${i}`,{name:g}),u(),l.success("Thành công")}catch{l.error(ye.error)}}}),e.jsx("div",{className:"text-gray-400 cursor-pointer hover:text-black",onClick:()=>a(!1),children:e.jsx(ge,{})})]}):e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{to:`/admin/server/${i}`,className:"text-sm font-primary text-primary",target:"_blank",children:n}),e.jsx("div",{className:"text-gray-400 cursor-pointer hover:text-black",onClick:()=>a(!0),children:e.jsx(fe,{})})]})},Oe=({server:n})=>e.jsxs(ae.Fragment,{children:[e.jsx(De,{server:n,icon:!0}),e.jsx(Ee,{server:n,icon:!0})]}),Xe=je({apiUrl:w().required("This field is required"),fingerPrint:w().required("This field is required"),remark:w().required("This field is required"),location:w().required("This field is required"),cloudManagerId:w().required("This field is required"),totalBandWidth:ve().required("This field is required").default(3e3),active:Ne().required()}).required(),ss=()=>{var G,Z,Y,J;const n=we(),i=be(s=>s.server),{value:u,handleToogleValue:d}=ke(!1),[a,g]=r.useState([]),[h,c]=r.useState(!1),[m,S]=r.useState(!1),[f,z]=r.useState(),[j,H]=r.useState(void 0),[C,V]=r.useState(""),[re,O]=r.useState(!1),[ne,F]=r.useState(!1),[A,le]=r.useState([]),{maintenanceServer:_,downServer:q}=r.useMemo(()=>({activeSever:a.filter(s=>s.status===1).length,downServer:a.filter(s=>s.status===2).length,maintenanceServer:a.filter(s=>s.status===3).length}),[a]),T=a.filter(s=>s.name.toLowerCase().includes(C.toLowerCase())||s.hostnameForAccessKeys.toLowerCase().includes(C.toLowerCase()));r.useEffect(()=>{(async()=>{try{const s=await x.get("/locations");le(s.data)}catch(s){console.log("error - ",s)}})()},[]);const{handleSubmit:ie,control:I,reset:X,watch:$,setValue:D,formState:{errors:p}}=Se({resolver:qe(Xe),mode:"onSubmit",defaultValues:{totalBandWidth:3e3,active:!1,apiUrl:"",fingerPrint:"",location:"",remark:"",cloudManagerId:""}}),oe=$("location"),E=$("active"),ce=$("cloudManagerId");r.useEffect(()=>{v()},[]);const v=async()=>{var s;try{S(!0);const t=await x.get("/servers/normal-server");g(t.data),n(Ce(t.data))}catch(t){if(k.isAxiosError(t))l.error((s=t.response)==null?void 0:s.data.message);else return"An unexpected error occurred"}finally{S(!1)}},de=async s=>{var t;try{(await x.post("/servers",{...s,status:E?1:3})).data.isCheckUnique?l.warn("IP này đã được sử dụng không thể add"):(v(),l.success("Import Server thành công")),X(),F(!1)}catch(o){if(k.isAxiosError(o))console.log("error message: ",o),l.error((t=o.response)==null?void 0:t.data.message);else return console.log("unexpected error: ",o),"An unexpected error occurred"}},me=async(s,t)=>{var o;try{const{isConfirmed:N}=await W.fire({title:'<p class="leading-tight">Bạn có muốn migate key máy chủ này</p>',icon:"success",showCancelButton:!0,confirmButtonColor:"#1DC071",cancelButtonColor:"#d33",cancelButtonText:"Thoát",confirmButtonText:"Đồng ý"});N&&(c(!0),await x.post("/servers/migrate",{oldServerId:s,newServerId:t}),v(),R(),l.success("Migrate server thành công"))}catch(N){if(k.isAxiosError(N))console.log("error message: ",N),l.error((o=N.response)==null?void 0:o.data.message);else return console.log("unexpected error: ",N),"An unexpected error occurred"}finally{c(!1)}},K=r.useMemo(()=>[{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"STT"}),dataIndex:"index",key:"index",width:70,render:s=>e.jsx("p",{className:"text-sm font-primary",children:s+1})},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"Server Name"}),dataIndex:"name",key:"name",render:(s,t)=>e.jsx(Ve,{serverId:t._id,serverName:t.name,onSuccess:v})},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"Location"}),dataIndex:"location",key:"location",render:s=>e.jsx("p",{className:"text-sm font-primary",children:s}),filters:A.map(s=>({text:s.name,value:s.name})),onFilter:(s,t)=>typeof s=="boolean"?t.location===(s?"1":"0"):t.location===s},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"IP"}),dataIndex:"hostnameForAccessKeys",key:"hostnameForAccessKeys",render:s=>e.jsx("p",{className:"text-sm font-primary",children:s})},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"Days"}),dataIndex:"hostnameForAccessKeys",key:"hostnameForAccessKeys",render:(s,t)=>{const o=y().diff(y(t.createdAt),"days");return e.jsx("p",{className:"text-sm font-primary",children:o<1?`${y(t.updatedAt).diff(y(t.createdAt),"hour")} giờ`:`${o} ngày`})}},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"Key "}),dataIndex:"usedkey",key:"usedkey",width:70,render:(s,t)=>e.jsx("p",{className:"text-sm font-primary",children:t.numberKey})},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"Max using"}),dataIndex:"maxUsage",key:"maxUsage",render:s=>e.jsxs("p",{className:"text-sm font-primary",children:[s?s/1e3/1e3/1e3:"00.00","GB"]})},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"dataTransfer"}),dataIndex:"dataTransfer",key:"dataTransfer",render:s=>e.jsxs("p",{className:"text-sm font-primary",children:[s?(s/1e3/1e3/1e3).toFixed(2):"00.00","GB"]})},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"Created At"}),dataIndex:"createdAt",key:"createdAt",render:(s,t)=>e.jsx("p",{className:"text-sm font-primary",children:P(t.createdAt)})},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary"}),dataIndex:"action",key:"action",width:170,render:(s,t)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ze,{serverId:t._id,status:t.status,handleFetchData:v}),t.status===1||t.status===3||t.status===2?e.jsxs(ae.Fragment,{children:[e.jsx(Ae,{title:"Migrate server",children:e.jsx("button",{className:"flex items-center justify-center w-7 text-xs font-medium text-white rounded-lg bg-secondary40 font-primary",onClick:()=>{z(t._id),ue()},children:e.jsx(Te,{className:"size-4"})})}),e.jsx(Oe,{server:t})]}):"",e.jsx(He,{handleFetchData:v,serverId:t._id,serverName:t.name})]})}],[A]),xe=r.useMemo(()=>[{title:()=>e.jsx("p",{className:"font-semibold font-primary",children:"STT"}),dataIndex:"index",key:"index",width:70,render:s=>e.jsx("p",{className:"text-sm font-primary",children:s+1})},{title:()=>e.jsx("p",{className:"font-semibold font-primary",children:"Server Name"}),dataIndex:"email",key:"email",render:(s,t)=>e.jsx(te,{to:`/admin/server/${t._id}`,className:"text-sm font-primary text-primary",children:t.name})},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"IP"}),dataIndex:"hostnameForAccessKeys",key:"hostnameForAccessKeys",render:s=>e.jsx("p",{className:"text-sm font-primary",children:s})},{title:()=>e.jsx("p",{className:"text-sm font-semibold font-primary",children:"Tổng ngày hoạt động"}),dataIndex:"hostnameForAccessKeys",key:"hostnameForAccessKeys",render:(s,t)=>{const o=y(t.updatedAt).diff(y(t.createdAt),"days");return e.jsx("p",{className:"text-sm font-primary",children:o<1?`${y(t.updatedAt).diff(y(t.createdAt),"hour")} giờ`:`${o} ngày`})}},{title:()=>e.jsx("p",{className:"font-semibold font-primary",children:"Location"}),dataIndex:"location",key:"location",render:(s,t)=>e.jsx("p",{className:"text-sm font-primary",children:t.location}),filters:A.map(s=>({text:s.name,value:s.name})),onFilter:(s,t)=>typeof s=="boolean"?t.location===(s?"1":"0"):t.location===s},{title:()=>e.jsx("p",{className:"font-semibold font-primary",children:"Trạng thái"}),dataIndex:"status",key:"status",render:s=>e.jsx("p",{className:"text-sm font-primary",children:s?e.jsx(Q,{color:"green",children:e.jsx("span",{className:"font-primary",children:"Đang hoạt động"})}):e.jsx(Q,{color:"red",children:e.jsx("span",{className:"font-primary",children:"Đã xóa"})})})},{title:()=>e.jsx("p",{className:"font-semibold font-primary",children:"Ngày tạo"}),dataIndex:"createdAt",key:"createdAt",render:s=>e.jsx("p",{className:"text-sm font-primary",children:P(s)})},{title:()=>e.jsx("p",{className:"font-semibold font-primary",children:"Ngày cập nhật"}),dataIndex:"updatedAt",key:"updatedAt",render:s=>e.jsx("p",{className:"text-sm font-primary",children:P(s)})}],[A]),ue=()=>{O(!0)},R=()=>{f&&(z(void 0),H(void 0)),O(!1)},he=s=>{const t=s.target.value;V(t)};return e.jsxs(Ie,{rolePage:[1,3],children:[h&&e.jsx(Be,{}),e.jsxs("div",{className:"space-y-10",children:[e.jsxs("div",{className:"grid grid-cols-2 p-5 gap-5 md:grid-cols-5 rounded-xl border-2 border-[#eeeeed]",children:[e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx("p",{className:"text-lg text-gray-500",children:"Total servers"}),e.jsxs("p",{className:"text-2xl font-medium",children:[a.filter(s=>s.status===1||s.status===3).length,"/",a.length]})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx("p",{className:"text-lg text-primary20",children:"Active"}),e.jsx("p",{className:"text-2xl font-medium text-primary20",children:a.filter(s=>s.status===1).length})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx("p",{className:"text-lg text-[#ffaa01]",children:"Maintenance"}),e.jsx("p",{className:"text-2xl font-medium text-[#ffaa01]",children:_})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx("p",{className:"text-lg text-error",children:"Down"}),e.jsx("p",{className:"text-2xl font-medium text-error",children:q})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx("p",{className:"text-lg text-gray-500",children:"Total keys"}),e.jsx("p",{className:"text-2xl font-medium",children:Ge({})})]})]}),e.jsx(ee,{centered:!0,open:ne,onCancel:()=>{X(),F(!1)},footer:[],children:e.jsxs("div",{className:"space-y-5",children:[e.jsx(b,{children:"Thêm máy chủ"}),e.jsxs("form",{className:"space-y-5",onSubmit:ie(de),children:[e.jsx("div",{className:"w-full lg:flex-1",children:e.jsx(Ke,{location:oe,onSelectLocation:s=>{console.log("value - ",s),D("location",s)},error:(G=p==null?void 0:p.location)!=null&&G.message?p.location.message:void 0})}),e.jsx("div",{className:"w-full lg:flex-1",children:e.jsx(Re,{data:ce,onSelect:s=>{D("cloudManagerId",s)},error:(Z=p==null?void 0:p.cloudManagerId)!=null&&Z.message?p==null?void 0:p.cloudManagerId.message:void 0})}),e.jsx("div",{className:"w-full lg:flex-1",children:e.jsx(U,{name:"totalBandWidth",type:"number",placeholder:"Total BandWidth",control:I})}),e.jsx("div",{className:"w-full lg:flex-1",children:e.jsx(U,{name:"apiUrl",placeholder:"apiUrl",control:I})}),e.jsx("div",{className:"w-full lg:flex-1",children:e.jsx(U,{name:"fingerPrint",placeholder:"fingerPrint",control:I})}),e.jsx(Me,{name:"remark",placeholder:"remark",control:I,className:"!h-[100px]"}),e.jsx(Pe,{checked:E,onClick:()=>D("active",!E),children:"Active"}),e.jsx(Le,{className:"w-full px-5 py-2 text-white bg-secondary20 lg:w-fit",type:"submit",children:"Thêm máy chủ"})]})]})}),e.jsxs("div",{className:"flex gap-5",children:[e.jsx("button",{className:"py-2 px-5 text-white bg-secondary20 rounded-lg font-medium",type:"button",onClick:()=>F(!0),children:"Thêm máy chủ"}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"text",value:C,onChange:he,className:"focus:border-primary text-black text-sm font-medium placeholder:text-text4 py-[15px] px-[25px] rounded-[10px] border border-solid w-full bg-inherit peer outline-none border-strock",placeholder:"Search..."}),C.length>0?e.jsx("span",{className:"absolute -translate-y-1/2 cursor-pointer right-5 top-1/2",onClick:()=>V(""),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-5 h-5 text-icon-color",children:e.jsx("path",{fillRule:"evenodd",d:"M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z",clipRule:"evenodd"})})}):null]})]}),e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(b,{children:["Danh sách máy chủ active(",a.filter(s=>s.status===1).length,")"]})}),e.jsx(B,{loading:m,dataSource:M.orderBy(T.filter(s=>s.status===1).map((s,t)=>({index:t,...s})),["createdAt"],["desc"]),columns:K,scroll:{x:1120}}),_>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(b,{children:["Danh sách máy chủ Maintenance(",_,")"]})}),e.jsx(B,{loading:m,dataSource:M.orderBy(T.filter(s=>s.status===3).map((s,t)=>({index:t,...s})),["createdAt"],["desc"]),columns:K,scroll:{x:1120}})]}):null,q>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(b,{children:["Danh sách máy chủ Down(",q,")"]})}),e.jsx(B,{loading:m,dataSource:M.orderBy(T.filter(s=>s.status===2).map((s,t)=>({index:t,...s})),["createdAt"],["desc"]),columns:K,scroll:{x:1120}})]}):null,e.jsxs("div",{className:"flex items-center gap-5",children:[e.jsx(b,{children:"Lịch sử máy chủ"}),e.jsx(Fe,{className:"cursor-pointer text-black",open:u,onClick:d})]}),u?e.jsx(B,{loading:m,dataSource:M.orderBy(T.filter(s=>s.status===0).map((s,t)=>({index:t,...s})),["updatedAt"],["desc"]),columns:xe,scroll:{x:1120}}):null]}),e.jsxs(ee,{title:`Máy chủ source ${(Y=a.find(s=>s._id===f))==null?void 0:Y.name}`,open:re,onCancel:()=>{R()},footer:[],children:[e.jsx("div",{className:"mb-3",children:f&&i.filter(s=>s._id!==f).length===0&&e.jsx("p",{className:"text-error font-primary",children:"Bạn cần thêm server mới để migrate key sang"})}),e.jsx("div",{className:"mb-5",children:e.jsxs(L,{children:[e.jsx(L.Select,{placeholder:j?e.jsx("span",{className:"text-black",children:(J=i.find(s=>s._id===j))==null?void 0:J.name}):e.jsx("span",{className:"text-text4",children:"Chọn server"})}),e.jsx(L.List,{children:[...i.filter(s=>s.status===1),...i.filter(s=>s.status===3)].map(s=>s._id!==f?e.jsx(L.Option,{onClick:()=>H(s._id),children:e.jsxs("span",{className:se("capitalize",j&&j===s._id?"font-semibold text-primary":""),children:[s.name," (",s.numberKey," keys)"," ",s.status===3&&e.jsx("span",{className:"text-error",children:"*"})]})},_e()):null)})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-5",children:[e.jsx("button",{className:"px-4 py-2 text-sm font-medium text-white rounded-lg bg-error font-primary",onClick:()=>R(),children:"Thoát"}),e.jsx("button",{className:"px-4 py-2 text-sm font-medium text-white rounded-lg bg-secondary40 font-primary",onClick:()=>{f&&j?me(f,j):l.warn("bạn chưa chọn server để migrate key sang")},children:"Migrate key"})]})]})]})},Ge=({serverId:n=""})=>{const[i,u]=r.useState(0);return r.useEffect(()=>{(async()=>{try{const d=await x.get(`/keys?serverId=${n}&status=1`);u(d.data.totalItems)}catch(d){console.log(d)}})()},[n]),i};export{ss as default};
